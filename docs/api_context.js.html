<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>api/context.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-heroku-deploy-guide.html">Heroku Deploy Guide</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="API.html">API</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="API.html#_checkPermissions">_checkPermissions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="API.html#_processQueue">_processQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="API.html#call">call</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="API.html#scheduleCall">scheduleCall</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="API.html#send">send</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Bot.html">Bot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#start">start</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Button.html">Button</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Context.html">Context</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#attach">attach</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#keyboard">keyboard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#noAutoSend">noAutoSend</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#removeKeyboard">removeKeyboard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#send">send</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#setPid">setPid</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Context.html#text">text</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Core.html">Core</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_escapeRegex">_escapeRegex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_event">_event</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_generateHelpMessage">_generateHelpMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_isLocked">_isLocked</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_registerMessageNewHandler">_registerMessageNewHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_tryHandleCommand">_tryHandleCommand</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_tryHandlePayload">_tryHandlePayload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#_tryHandleRegex">_tryHandleRegex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#cmd">cmd</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#help">help</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#lock">lock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#noEventWarnings">noEventWarnings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#on">on</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#parseRequest">parseRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#payload">payload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Core.html#regex">regex</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Keyboard.html">Keyboard</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html">LogMessageBuilder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#_log">_log</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#e">e</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#from">from</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#i">i</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#now">now</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#r">r</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#text">text</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#type">type</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log-LogMessageBuilder.html#w">w</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Stats.html">Stats</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stats.html#event">event</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stats.html#getEventCount">getEventCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stats.html#print">print</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stats.html#sent">sent</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-log.html">log</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log.html#.requireFunction">requireFunction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log.html#.requireParam">requireParam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log.html#~log">log</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#bot">bot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#colors">colors</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#vk">vk</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">api/context.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file A part of `vk-chat-bot` node.js framework.
 * Defines the {@link Context} class.
 *
 * @author Artem Varaksa &lt;aymfst@gmail.com>
 * @copyright Artem Varaksa 2017-2018
 */

import { Keyboard } from './keyboard'
import { log, requireParam } from '../extra/log'
import '@babel/polyfill'

export default class Context {
  /**
   * @class Context
   *
   * @param {API} api the API object
   * @param {string} eventType the event type
   * @param {Object} object full object from Callback API
   * @param {string} message the message
   *
   * @return {Context}
   *
   * @classdesc
   * Context, which is passed to every [handler]{@link handler}
   */
  constructor (api, eventType, object, message) {
    /**
     * API
     * @type {API}
     * @memberof Context
     */
    this.api = api

    /**
     * Full object passed by Callback API
     *
     * **Note:** If `message_new`, `message_reply`, `message_edit` or `no_match` event, this is a [Private message object](https://vk.com/dev/objects/message).
     * Else, see [Callback API docs](https://vk.com/dev/callback_api) or [Groups Events docs](https://vk.com/dev/groups_events) for more information.
     * @type {Object}
     * @memberof Context
     */
    this.obj = object

    /**
     * Incoming user message
     * **Note:** If `cmd()` handler, contains message without `cmd_prefix` and the command
     * @type {string}
     * @memberof Context
     */
    this.msg = message

    /**
     * Name of the event
     * @type {string}
     * @memberof Context
     */
    this.eventType = eventType

    /**
     * Does this `Context`'s response need auto-sending?
     * @readonly
     * @see Context#noAutoSend
     * @type {boolean}
     * @memberof Context
     */
    this.autoSend = true

    this.clear()
  }

  /**
   * Prevents this handler from sending the message automatically after it finishes
   *
   * @memberof Context
   * @instance
   */
  noAutoSend () {
    this.autoSend = false
  }

  /**
   * Sets a new peer ID
   *
   * @param {string|number} pid new peer ID
   * @memberof Context
   * @instance
   */
  setPid (pid) {
    this._pid = pid
  }

  /**
   * Sets the reply message text
   *
   * @param {string} txt new text
   * @memberof Context
   * @instance
   */
  text (txt) {
    this._replyText = txt
  }

  /**
   * Adds an attachment to the message
   * **Note:** More information on the parameters can be found in [VK API docs](https://vk.com/dev/messages.send)
   *
   * @param {string} type the type of attachment
   * @param {string|number} ownerId resource owner ID
   * @param {string|number} resId resource ID
   * @param {string} [accessKey] resource access key, if needed; see [Access Key](https://vk.com/dev/access_key) page in API docs for more information
   * @memberof Context
   * @instance
   */
  attach (type, ownerId, resId, accessKey) {
    requireParam('Context#attach', type, 'attachment type')
    requireParam('Context#attach', ownerId, 'owner id')
    requireParam('Context#attach', resId, 'resource id')

    if (accessKey) {
      this._attachment.push(`${type}${ownerId}_${resId}_${accessKey}`)
    } else {
      this._attachment.push(`${type}${ownerId}_${resId}`)
    }
  }

  /**
   * Attaches a keyboard
   *
   * @param {Keyboard} kbd the keyboard
   * @memberof Context
   * @instance
   *
   * @example
   *
   * var Keyboard = vk.kbd.Keyboard
   * var Button = vk.kbd.Button
   * var colors = vk.kbd.colors
   *
   * core.cmd('keyboard', $ => {
   *     // Set 'true' instead of 'false' to make it disappear after a button was pressed
   *     var kbd = new Keyboard([
   *         // Rows
   *         [
   *             new Button('Default'),
   *             new Button('Primary', colors.primary),
   *             new Button('Negative', colors.negative),
   *             new Button('Positive', colors.positive)
   *         ],
   *         [
   *             new Button('Maximum rows is 10, columns - 4.')
   *         ],
   *    ], false)
   *
   *    $.text('Here is your keyboard, as promised.')
   *    $.keyboard(kbd)
   * }, 'demo keyboard')
   */
  keyboard (kbd) {
    this._kbdObject = JSON.stringify(kbd)
  }

  /**
   * Attaches an empty keyboard
   *
   * @memberof Context
   * @instance
   */
  removeKeyboard () {
    this.keyboard(new Keyboard())
  }

  /**
   * Sends the composed message to user
   * **Note:** After the handler finishes its work, this method is called automatically (if [noAutoSend]{@link Context#noAutoSeng} was not called)
   *
   * @memberof Context
   * @instance
   */
  async send () {
    if (this.eventType === 'message_deny') {
      log().w(`No message was sent to peer ${this._pid} ("message_deny" event)`).from('ctx').now()
      return
    }

    if (this._replyText === '' &amp;&amp; this._attachment === []) {
      log().w('ctx', `No message was sent to peer ${this._pid} (text or attachment is required)`).from('ctx').now()
      return
    }

    var attachmentList = this._attachment.join(',')
    return this.api.send(this._pid, this._replyText, attachmentList, this._kbdObject)
  }

  /**
   * Clears the buffer and resets the User ID back to original
   * For example, after calling this you can compose another message to the same user
   *
   * @memberof Context
   * @instance
   */
  clear () {
    /**
     * Text, which will be used in the reply
     * @private
     * @type {string}
     * @memberof Context
     */
    this._replyText = ''

    /**
     * Attachment, which will be used in the reply
     * @private
     * @type {string}
     * @memberof Context
     */
    this._attachment = []

    /**
     * Object of the [Keyboard]{@link Keyboard}, which will be used in the reply
     * @private
     * @type {Object}
     * @memberof Context
     */
    this._kbdObject = ''

    if (this.eventType === 'message_allow') {
      /**
       * The ID of a peer, to which the reply is going to be sent
       *
       * **Note:** You can change this using [`setPid()`](#setpid) method, the original Peer ID is available in `$.obj.peer_id`
       * @private
       * @type {string|number}
       * @memberof Context
       */
      this._pid = this.obj.user_id
    } else if (this.eventType === 'message_typing_state') {
      this._pid = this.obj.from_id
    } else {
      this._pid = this.obj.peer_id
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
